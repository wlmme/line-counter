# Line Counter - 行数统计工具

一个使用 Rust 编写的命令行工具，用于统计文件的行数，并提供详细的文件分析信息。

## 功能特性

- 📊 **精确统计**: 统计总行数、非空行数和空行数
- 📏 **文件信息**: 显示文件大小和空行占比
- 🛡️ **安全检查**: 文件大小限制，避免处理过大文件
- 🚀 **性能优化**: 使用缓冲读取，高效处理大文件
- 🎯 **智能错误处理**: 使用 `thiserror` 和 `anyhow` 提供清晰的错误信息
- 🌏 **中文友好**: 支持中文文件内容和错误提示

## 安装和使用

### 编译

```bash
cargo build --release
```

### 运行

```bash
# 基本用法
cargo run -- <文件路径>

# 示例
cargo run -- example.txt
cargo run -- /path/to/your/file.txt
```

### 使用编译后的二进制文件

```bash
./target/release/line-counter <文件路径>
```

## 错误处理

该工具使用了现代 Rust 错误处理最佳实践：

### 使用的库

- **`thiserror`**: 用于定义结构化的自定义错误类型
- **`anyhow`**: 用于错误传播和上下文信息

### 错误类型

工具会识别并友好地处理以下错误情况：

| 错误类型 | 描述 | 示例 |
|---------|------|------|
| `MissingArgument` | 缺少文件路径参数 | `cargo run` |
| `FileNotFound` | 文件不存在 | `cargo run -- nonexistent.txt` |
| `IsDirectory` | 指定路径是目录而非文件 | `cargo run -- src/` |
| `PermissionDenied` | 权限不足，无法访问文件 | 受保护的系统文件 |
| `FileTooLarge` | 文件过大（超过 100MB） | 大型数据文件 |
| `FileReadError` | 文件读取错误 | 损坏的文件 |
| `IoError` | 通用 I/O 错误 | 网络文件系统错误 |

### 错误信息示例

```bash
# 缺少参数
❌ 错误: 缺少文件路径参数
📖 用法: line-counter <文件路径>
💡 示例: line-counter example.txt

# 文件不存在
Error: 文件不存在: nonexistent.txt

# 尝试处理目录
Error: 文件是一个目录，不是文件: src

# 文件过大
Error: 文件过大，无法处理: huge_file.txt, 大小: 209715200 bytes
```

## 输出格式

成功执行时，工具会输出详细的分析结果：

```
📊 正在处理文件: example.txt
✅ 文件分析完成!
📄 文件: example.txt
📏 文件大小: 1234 bytes
📊 总行数: 50
📝 非空行数: 42
🔲 空行数: 8
📈 空行占比: 16.0%
```

## 技术实现

### 代码结构

项目采用模块化设计，包含以下主要组件：

1. **主函数** (`main`)：处理命令行参数和流程控制
2. **错误类型** (`LineCounterError`)：结构化错误定义
3. **统计结构** (`LineStats`)：行数统计结果
4. **辅助函数**：文件验证、统计计算、结果输出

### 错误处理架构

1. **自定义错误类型** (`LineCounterError`):
   - 使用 `thiserror` 派生宏自动实现错误特征
   - 提供结构化的错误信息和上下文
   - 支持错误链和原因追踪
   - 8 种具体的错误类型覆盖所有场景

2. **错误传播**:
   - 使用 `anyhow::Result` 简化错误传播
   - 使用 `Context` trait 添加错误上下文
   - 自动转换标准库错误类型
   - 友好的中文错误消息

3. **错误分类**:
   - 文件系统错误（不存在、权限等）
   - 用户输入错误（参数缺失、路径无效）
   - 系统限制错误（文件过大）
   - I/O 错误（读取失败）

### 性能优化

- 使用 `BufReader` 进行缓冲 I/O
- 预检查文件元数据避免不必要的读取
- 设置文件大小限制防止内存溢出
- 逐行处理，内存占用恒定

### 文档注释

代码包含详细的文档注释：

- 模块级文档说明整体功能
- 函数文档包含参数、返回值、错误情况
- 结构体和枚举的完整说明
- 示例代码和使用场景
- 错误处理的详细说明

使用 `cargo doc --open` 查看完整的 API 文档。

## 测试

本项目包含全面的测试套件，分为单元测试和集成测试。

### 运行所有测试

```bash
cargo test
```

### 单元测试

单元测试位于 `src/main.rs` 中，测试内部组件：

```bash
cargo test --lib
```

测试覆盖：
- 自定义错误类型的显示格式
- `LineStats` 结构体的功能
- 错误消息的准确性
- 边界条件处理（空文件、100%空行等）

### 集成测试

集成测试位于 `tests/integration_tests.rs` 中，测试完整的应用程序功能：

```bash
cargo test --test integration_tests
```

集成测试覆盖：
- 基本文件行数统计
- 空文件和只有空行的文件
- Unicode 和特殊字符处理
- 大文件处理
- 错误情况（文件不存在、目录输入等）
- 二进制文件处理
- 各种行结束符处理
- 空白字符行处理

### 错误处理测试脚本

项目还包含一个 shell 脚本来测试各种错误情况：

```bash
./test_errors.sh
```

该脚本会：
- 构建 release 版本
- 测试各种错误场景
- 验证错误消息的准确性
- 清理测试文件
- 提供详细的测试报告

### 生成文档

查看完整的 API 文档：

```bash
cargo doc --open
```

这将生成并打开包含所有文档注释的 HTML 文档。

## 依赖

```toml
[dependencies]
anyhow = "1.0.98"      # 错误处理和上下文
thiserror = "2.0.12"   # 自定义错误类型
```

## 许可证

MIT License

## 贡献

欢迎提交 Issue 和 Pull Request！

## 更新日志

### v0.1.0
- 基本行数统计功能
- 使用 `thiserror` 和 `anyhow` 优化错误处理
- 添加详细的错误提示和用户友好的输出
- 支持空行统计和占比分析
- 添加文件大小限制和安全检查
- 完善的文档注释和 API 文档
- 分离的集成测试和单元测试
- 全面的错误处理测试脚本
- 支持 Unicode 和特殊字符处理
- 模块化的代码结构设计